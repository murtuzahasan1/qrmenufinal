<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Menu System - QR Code Generator</title>
    <link rel="stylesheet" href="../assets/css/style.css">
</head>
<body>
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <svg fill="currentColor" viewBox="0 0 24 24">
                        <path d="M3 11h8V3H3v8zm2-6h4v4H5V5zm8-2v8h8V3h-8zm6 6h-4V5h4v4zM3 21h8v-8H3v8zm2-6h4v4H5v-4zm13-2h3v2h-3v-2zm0 4h3v2h-3v-2zm0 4h3v2h-3v-2zM14 7h2v2h-2V7zm0 8h2v2h-2v-2zM9 3h2v2H9V3zm0 16h2v2H9v-2z"/>
                    </svg>
                    QR Menu System
                </div>
                <nav>
                    <ul class="nav-menu">
                        <li><a href="dashboard.html">Dashboard</a></li>
                        <li><a href="restaurants.html">Restaurants</a></li>
                        <li><a href="branches.html">Branches</a></li>
                        <li><a href="menu.html">Menu</a></li>
                        <li><a href="orders.html">Orders</a></li>
                        <li><a href="users.html">Users</a></li>
                        <li><a href="qrcode.html" class="active">QR Codes</a></li>
                        <li><a href="#" onclick="logout()">Logout</a></li>
                    </ul>
                </nav>
            </div>
        </div>
    </header>

    <main class="dashboard">
        <div class="container">
            <div class="dashboard-header">
                <h1 class="dashboard-title">QR Code Generator</h1>
                <div class="user-info">
                    <span id="userName">Loading...</span>
                    <div class="user-avatar" id="userAvatar">A</div>
                </div>
            </div>

            <div class="content-card">
                <div class="card-header">
                    <h2 class="card-title">Generate QR Codes</h2>
                </div>
                <div class="card-content">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="qrType">QR Code Type</label>
                            <select id="qrType" onchange="updateFormFields()">
                                <option value="branch">Branch QR Code</option>
                                <option value="table">Table QR Code</option>
                                <option value="menu_item">Menu Item QR Code</option>
                                <option value="order">Order QR Code</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="restaurantSelect">Restaurant</label>
                            <select id="restaurantSelect" onchange="loadBranches()">
                                <option value="">Select Restaurant</option>
                            </select>
                        </div>
                        <div class="form-group" id="branchGroup" style="display: none;">
                            <label for="branchSelect">Branch</label>
                            <select id="branchSelect">
                                <option value="">Select Branch</option>
                            </select>
                        </div>
                        <div class="form-group" id="tableGroup" style="display: none;">
                            <label for="tableNumber">Table Number</label>
                            <input type="text" id="tableNumber" placeholder="e.g., 1, A1, etc.">
                        </div>
                        <div class="form-group" id="itemGroup" style="display: none;">
                            <label for="itemSelect">Menu Item</label>
                            <select id="itemSelect">
                                <option value="">Select Item</option>
                            </select>
                        </div>
                        <div class="form-group" id="orderGroup" style="display: none;">
                            <label for="orderSelect">Order</label>
                            <select id="orderSelect">
                                <option value="">Select Order</option>
                            </select>
                        </div>
                    </div>
                    <div style="margin-top: 1rem;">
                        <button class="btn-primary" onclick="generateQR()">Generate QR Code</button>
                        <button class="btn-secondary" onclick="generateBatchQR()">Generate Batch</button>
                    </div>
                </div>
            </div>

            <div class="content-card" id="qrResultCard" style="display: none;">
                <div class="card-header">
                    <h2 class="card-title">Generated QR Code</h2>
                    <button class="btn-primary" onclick="downloadQR()">Download</button>
                </div>
                <div class="card-content">
                    <div class="qr-container">
                        <div class="qr-code">
                            <img id="qrImage" src="" alt="QR Code">
                        </div>
                        <div class="qr-info">
                            <p>Scan this QR code to access the menu</p>
                            <p id="qrDetails"></p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="content-card" id="batchResultCard" style="display: none;">
                <div class="card-header">
                    <h2 class="card-title">Batch QR Codes</h2>
                    <button class="btn-primary" onclick="downloadAllQR()">Download All</button>
                </div>
                <div class="card-content">
                    <div id="batchResults"></div>
                </div>
            </div>
        </div>
    </main>

    <script src="../assets/js/app.js"></script>
    <script>
        let currentUser = null;
        let restaurants = [];
        let branches = [];
        let menuItems = [];
        let orders = [];
        let currentQRUrl = null;
        let batchResults = [];

        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // Check authentication
                const authResult = await APIService.getCurrentUser();
                if (!authResult.success) {
                    window.location.href = '../login.html';
                    return;
                }

                currentUser = authResult.user;
                updateUserInterface(currentUser);

                // Load data
                await loadRestaurants();
                await loadMenuItems();
                await loadOrders();

            } catch (error) {
                console.error('QR Code page initialization failed:', error);
                window.location.href = '../login.html';
            }
        });

        function updateUserInterface(user) {
            document.getElementById('userName').textContent = user.name;
            document.getElementById('userAvatar').textContent = user.name.charAt(0).toUpperCase();
        }

        async function loadRestaurants() {
            try {
                const result = await APIService.getAdminRestaurants();
                if (result.success) {
                    restaurants = result.data;
                    updateRestaurantSelect();
                }
            } catch (error) {
                console.error('Failed to load restaurants:', error);
                Utils.showToast('Failed to load restaurants', 'error');
            }
        }

        async function loadBranches() {
            const restaurantId = document.getElementById('restaurantSelect').value;
            if (!restaurantId) return;

            try {
                const result = await APIService.getAdminBranches(restaurantId);
                if (result.success) {
                    branches = result.data;
                    updateBranchSelect();
                }
            } catch (error) {
                console.error('Failed to load branches:', error);
                Utils.showToast('Failed to load branches', 'error');
            }
        }

        async function loadMenuItems() {
            const restaurantId = currentUser.restaurant_id;
            try {
                const result = await APIService.getAdminMenu(restaurantId, 'items');
                if (result.success) {
                    menuItems = result.data;
                    updateItemSelect();
                }
            } catch (error) {
                console.error('Failed to load menu items:', error);
                Utils.showToast('Failed to load menu items', 'error');
            }
        }

        async function loadOrders() {
            const restaurantId = currentUser.restaurant_id;
            try {
                const result = await APIService.getAdminOrders(restaurantId);
                if (result.success) {
                    orders = result.data;
                    updateOrderSelect();
                }
            } catch (error) {
                console.error('Failed to load orders:', error);
                Utils.showToast('Failed to load orders', 'error');
            }
        }

        function updateRestaurantSelect() {
            const select = document.getElementById('restaurantSelect');
            select.innerHTML = '<option value="">Select Restaurant</option>';
            
            restaurants.forEach(restaurant => {
                const option = document.createElement('option');
                option.value = restaurant.id;
                option.textContent = restaurant.name;
                select.appendChild(option);
            });

            // Auto-select if user has restaurant access
            if (currentUser.restaurant_id) {
                select.value = currentUser.restaurant_id;
                loadBranches();
            }
        }

        function updateBranchSelect() {
            const select = document.getElementById('branchSelect');
            select.innerHTML = '<option value="">Select Branch</option>';
            
            branches.forEach(branch => {
                const option = document.createElement('option');
                option.value = branch.id;
                option.textContent = branch.name;
                select.appendChild(option);
            });
        }

        function updateItemSelect() {
            const select = document.getElementById('itemSelect');
            select.innerHTML = '<option value="">Select Item</option>';
            
            menuItems.forEach(item => {
                const option = document.createElement('option');
                option.value = item.id;
                option.textContent = item.name;
                select.appendChild(option);
            });
        }

        function updateOrderSelect() {
            const select = document.getElementById('orderSelect');
            select.innerHTML = '<option value="">Select Order</option>';
            
            orders.forEach(order => {
                const option = document.createElement('option');
                option.value = order.id;
                option.textContent = `Order #${order.id} - ${Utils.formatDate(order.created_at)}`;
                select.appendChild(option);
            });
        }

        function updateFormFields() {
            const qrType = document.getElementById('qrType').value;
            
            // Hide all groups
            document.getElementById('branchGroup').style.display = 'none';
            document.getElementById('tableGroup').style.display = 'none';
            document.getElementById('itemGroup').style.display = 'none';
            document.getElementById('orderGroup').style.display = 'none';
            
            // Show relevant groups
            switch (qrType) {
                case 'branch':
                    document.getElementById('branchGroup').style.display = 'block';
                    break;
                case 'table':
                    document.getElementById('branchGroup').style.display = 'block';
                    document.getElementById('tableGroup').style.display = 'block';
                    break;
                case 'menu_item':
                    document.getElementById('itemGroup').style.display = 'block';
                    break;
                case 'order':
                    document.getElementById('orderGroup').style.display = 'block';
                    break;
            }
        }

        async function generateQR() {
            const qrType = document.getElementById('qrType').value;
            const restaurantId = document.getElementById('restaurantSelect').value;
            
            if (!restaurantId) {
                Utils.showToast('Please select a restaurant', 'error');
                return;
            }

            let url = `/api/qrcode/index.php?action=generate&type=${qrType}&restaurant_id=${restaurantId}`;
            
            switch (qrType) {
                case 'branch':
                    const branchId = document.getElementById('branchSelect').value;
                    if (!branchId) {
                        Utils.showToast('Please select a branch', 'error');
                        return;
                    }
                    url += `&branch_id=${branchId}`;
                    break;
                case 'table':
                    const tableBranchId = document.getElementById('branchSelect').value;
                    const tableNumber = document.getElementById('tableNumber').value;
                    if (!tableBranchId || !tableNumber) {
                        Utils.showToast('Please select a branch and enter table number', 'error');
                        return;
                    }
                    url += `&branch_id=${tableBranchId}&table_number=${tableNumber}`;
                    break;
                case 'menu_item':
                    const itemId = document.getElementById('itemSelect').value;
                    if (!itemId) {
                        Utils.showToast('Please select a menu item', 'error');
                        return;
                    }
                    url += `&item_id=${itemId}`;
                    break;
                case 'order':
                    const orderId = document.getElementById('orderSelect').value;
                    if (!orderId) {
                        Utils.showToast('Please select an order', 'error');
                        return;
                    }
                    url += `&order_id=${orderId}`;
                    break;
            }

            try {
                const result = await Utils.fetchAPI(url);
                if (result.success) {
                    currentQRUrl = result.qr_url;
                    displayQRCode(result.qr_url, qrType);
                } else {
                    Utils.showToast(result.message, 'error');
                }
            } catch (error) {
                console.error('Failed to generate QR code:', error);
                Utils.showToast('Failed to generate QR code', 'error');
            }
        }

        async function generateBatchQR() {
            const qrType = document.getElementById('qrType').value;
            const restaurantId = document.getElementById('restaurantSelect').value;
            
            if (!restaurantId) {
                Utils.showToast('Please select a restaurant', 'error');
                return;
            }

            let url = `/api/qrcode/index.php?action=batch&type=${qrType}&restaurant_id=${restaurantId}`;
            
            if (qrType === 'table') {
                const branchId = document.getElementById('branchSelect').value;
                if (!branchId) {
                    Utils.showToast('Please select a branch', 'error');
                    return;
                }
                url += `&branch_id=${branchId}`;
            }

            try {
                const result = await Utils.fetchAPI(url);
                if (result.success) {
                    batchResults = result.qrcodes;
                    displayBatchResults(result.qrcodes);
                } else {
                    Utils.showToast(result.message, 'error');
                }
            } catch (error) {
                console.error('Failed to generate batch QR codes:', error);
                Utils.showToast('Failed to generate batch QR codes', 'error');
            }
        }

        function displayQRCode(qrUrl, type) {
            document.getElementById('qrImage').src = qrUrl;
            document.getElementById('qrDetails').textContent = `Type: ${type}`;
            document.getElementById('qrResultCard').style.display = 'block';
            document.getElementById('batchResultCard').style.display = 'none';
        }

        function displayBatchResults(qrCodes) {
            const container = document.getElementById('batchResults');
            container.innerHTML = '';
            
            const grid = document.createElement('div');
            grid.style.display = 'grid';
            grid.style.gridTemplateColumns = 'repeat(auto-fill, minmax(200px, 1fr))';
            grid.style.gap = '1rem';
            
            qrCodes.forEach(qrCode => {
                const item = document.createElement('div');
                item.style.textAlign = 'center';
                item.innerHTML = `
                    <img src="${qrCode.qr_url}" alt="QR Code" style="width: 150px; height: 150px; margin-bottom: 0.5rem;">
                    <div style="font-size: 0.875rem; color: #6b7280;">${qrCode.filename}</div>
                `;
                grid.appendChild(item);
            });
            
            container.appendChild(grid);
            document.getElementById('batchResultCard').style.display = 'block';
            document.getElementById('qrResultCard').style.display = 'none';
        }

        async function downloadQR() {
            if (!currentQRUrl) {
                Utils.showToast('No QR code to download', 'error');
                return;
            }

            try {
                const result = await Utils.fetchAPI(`/api/qrcode/index.php?action=download&qr_url=${encodeURIComponent(currentQRUrl)}`);
                if (result.success) {
                    Utils.showToast('QR code downloaded successfully', 'success');
                    // Create download link
                    const link = document.createElement('a');
                    link.href = result.filepath;
                    link.download = result.filename;
                    link.click();
                } else {
                    Utils.showToast(result.message, 'error');
                }
            } catch (error) {
                console.error('Failed to download QR code:', error);
                Utils.showToast('Failed to download QR code', 'error');
            }
        }

        async function downloadAllQR() {
            if (batchResults.length === 0) {
                Utils.showToast('No QR codes to download', 'error');
                return;
            }

            try {
                const result = await Utils.fetchAPI('/api/qrcode/index.php?action=create-pdf', {
                    method: 'POST',
                    body: JSON.stringify({
                        qrcodes: batchResults,
                        title: 'Batch QR Codes'
                    })
                });
                
                if (result.success) {
                    Utils.showToast('PDF created successfully', 'success');
                    // Create download link
                    const link = document.createElement('a');
                    link.href = result.filepath;
                    link.download = result.filename;
                    link.click();
                } else {
                    Utils.showToast(result.message, 'error');
                }
            } catch (error) {
                console.error('Failed to create PDF:', error);
                Utils.showToast('Failed to create PDF', 'error');
            }
        }

        async function logout() {
            try {
                await APIService.logout();
                Utils.showToast('Logged out successfully', 'success');
                setTimeout(() => {
                    window.location.href = '../login.html';
                }, 1000);
            } catch (error) {
                console.error('Logout failed:', error);
                Utils.showToast('Logout failed', 'error');
            }
        }
    </script>
</body>
</html>