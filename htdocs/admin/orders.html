<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Menu System - Order Management</title>
    <link rel="stylesheet" href="../assets/css/style.css">
</head>
<body>
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <svg fill="currentColor" viewBox="0 0 24 24">
                        <path d="M3 11h8V3H3v8zm2-6h4v4H5V5zm8-2v8h8V3h-8zm6 6h-4V5h4v4zM3 21h8v-8H3v8zm2-6h4v4H5v-4zm13-2h3v2h-3v-2zm0 4h3v2h-3v-2zm0 4h3v2h-3v-2zM14 7h2v2h-2V7zm0 8h2v2h-2v-2zM9 3h2v2H9V3zm0 16h2v2H9v-2z"/>
                    </svg>
                    QR Menu System
                </div>
                <nav>
                    <ul class="nav-menu">
                        <li><a href="dashboard.html">Dashboard</a></li>
                        <li><a href="restaurants.html">Restaurants</a></li>
                        <li><a href="branches.html">Branches</a></li>
                        <li><a href="menu.html">Menu</a></li>
                        <li><a href="orders.html" class="active">Orders</a></li>
                        <li><a href="users.html">Users</a></li>
                        <li><a href="qrcode.html">QR Codes</a></li>
                        <li><a href="modules.html">Modules</a></li>
                        <li><a href="#" onclick="logout()">Logout</a></li>
                    </ul>
                </nav>
            </div>
        </div>
    </header>

    <main class="dashboard">
        <div class="container">
            <div class="dashboard-header">
                <h1 class="dashboard-title">Order Management</h1>
                <div class="user-info">
                    <span id="userName">Loading...</span>
                    <div class="user-avatar" id="userAvatar">A</div>
                </div>
            </div>

            <!-- Filters -->
            <div class="content-card">
                <div class="card-header">
                    <h2 class="card-title">Filters</h2>
                </div>
                <div class="card-content">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="statusFilter">Status</label>
                            <select id="statusFilter" onchange="loadOrders()">
                                <option value="">All Status</option>
                                <option value="pending">Pending</option>
                                <option value="confirmed">Confirmed</option>
                                <option value="preparing">Preparing</option>
                                <option value="ready">Ready</option>
                                <option value="delivered">Delivered</option>
                                <option value="cancelled">Cancelled</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="branchFilter">Branch</label>
                            <select id="branchFilter" onchange="loadOrders()">
                                <option value="">All Branches</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="dateFilter">Date</label>
                            <input type="date" id="dateFilter" onchange="loadOrders()">
                        </div>
                        <div class="form-group">
                            <label for="searchFilter">Search</label>
                            <input type="text" id="searchFilter" placeholder="Order ID, Customer..." onkeyup="debounceSearch()">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Orders List -->
            <div class="content-card">
                <div class="card-header">
                    <h2 class="card-title">Orders</h2>
                    <div>
                        <button class="btn-secondary" onclick="exportOrders()">Export</button>
                        <button class="btn-primary" onclick="refreshOrders()">Refresh</button>
                    </div>
                </div>
                <div class="card-content">
                    <div id="ordersContainer">
                        <div class="spinner"></div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Order Details Modal -->
    <div id="orderModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Order Details</h3>
                <button class="close-btn" onclick="closeOrderModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="orderDetails">
                    <!-- Order details will be populated by JavaScript -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeOrderModal()">Close</button>
                <button class="btn btn-primary" id="updateOrderBtn" onclick="updateOrderStatus()">Update Status</button>
            </div>
        </div>
    </div>

    <script src="../assets/js/app.js"></script>
    <script>
        let currentUser = null;
        let orders = [];
        let branches = [];
        let currentOrder = null;
        let searchTimeout = null;

        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // Check authentication
                const authResult = await APIService.getCurrentUser();
                if (!authResult.success) {
                    window.location.href = '../login.html';
                    return;
                }

                currentUser = authResult.user;
                updateUserInterface(currentUser);

                // Load branches
                await loadBranches();

                // Load orders
                await loadOrders();

            } catch (error) {
                console.error('Orders page initialization failed:', error);
                window.location.href = '../login.html';
            }
        });

        function updateUserInterface(user) {
            document.getElementById('userName').textContent = user.name;
            document.getElementById('userAvatar').textContent = user.name.charAt(0).toUpperCase();
        }

        async function loadBranches() {
            try {
                const result = await APIService.getAdminBranches(currentUser.restaurant_id);
                if (result.success) {
                    branches = result.data;
                    updateBranchSelect();
                }
            } catch (error) {
                console.error('Failed to load branches:', error);
                Utils.showToast('Failed to load branches', 'error');
            }
        }

        function updateBranchSelect() {
            const select = document.getElementById('branchFilter');
            select.innerHTML = '<option value="">All Branches</option>';
            
            branches.forEach(branch => {
                const option = document.createElement('option');
                option.value = branch.id;
                option.textContent = branch.name;
                select.appendChild(option);
            });

            // Auto-select if user has branch access
            if (currentUser.branch_id) {
                select.value = currentUser.branch_id;
            }
        }

        async function loadOrders() {
            const status = document.getElementById('statusFilter').value;
            const branchId = document.getElementById('branchFilter').value;
            const date = document.getElementById('dateFilter').value;
            const search = document.getElementById('searchFilter').value;

            try {
                const result = await APIService.getAdminOrders(
                    currentUser.restaurant_id,
                    branchId || null,
                    status || null
                );
                
                if (result.success) {
                    orders = result.data;
                    filterAndDisplayOrders();
                } else {
                    showError('Failed to load orders: ' + result.message);
                }
            } catch (error) {
                console.error('Failed to load orders:', error);
                showError('Failed to load orders');
            }
        }

        function filterAndDisplayOrders() {
            const date = document.getElementById('dateFilter').value;
            const search = document.getElementById('searchFilter').value.toLowerCase();
            
            let filteredOrders = orders;

            // Filter by date
            if (date) {
                filteredOrders = filteredOrders.filter(order => {
                    return order.created_at.startsWith(date);
                });
            }

            // Filter by search
            if (search) {
                filteredOrders = filteredOrders.filter(order => {
                    return order.id.toString().includes(search) ||
                           (order.customer_name && order.customer_name.toLowerCase().includes(search)) ||
                           (order.customer_phone && order.customer_phone.includes(search));
                });
            }

            displayOrders(filteredOrders);
        }

        function displayOrders(ordersToDisplay) {
            const container = document.getElementById('ordersContainer');
            
            if (ordersToDisplay.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #6b7280;">No orders found.</p>';
                return;
            }

            const table = document.createElement('table');
            table.className = 'data-table';
            
            table.innerHTML = `
                <thead>
                    <tr>
                        <th>Order ID</th>
                        <th>Branch</th>
                        <th>Customer</th>
                        <th>Status</th>
                        <th>Payment</th>
                        <th>Total</th>
                        <th>Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    ${ordersToDisplay.map(order => `
                        <tr>
                            <td>#${order.id}</td>
                            <td>${order.branch_name}</td>
                            <td>${order.customer_name || 'N/A'}</td>
                            <td><span class="status-badge ${order.status}">${order.status}</span></td>
                            <td><span class="status-badge ${order.payment_status}">${order.payment_status}</span></td>
                            <td>${Utils.formatPrice(order.total_amount)}</td>
                            <td>${Utils.formatDate(order.created_at)}</td>
                            <td>
                                <button class="btn btn-secondary" onclick="viewOrder(${order.id})">View</button>
                                <button class="btn btn-primary" onclick="quickUpdateStatus(${order.id})">Update</button>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            `;
            
            container.innerHTML = '';
            container.appendChild(table);
        }

        function viewOrder(orderId) {
            const order = orders.find(o => o.id === orderId);
            if (!order) return;

            currentOrder = order;
            
            const detailsContainer = document.getElementById('orderDetails');
            detailsContainer.innerHTML = `
                <div style="margin-bottom: 2rem;">
                    <h4>Order Information</h4>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-top: 1rem;">
                        <div><strong>Order ID:</strong> #${order.id}</div>
                        <div><strong>Branch:</strong> ${order.branch_name}</div>
                        <div><strong>Table:</strong> ${order.table_number || 'N/A'}</div>
                        <div><strong>Date:</strong> ${Utils.formatDate(order.created_at)}</div>
                    </div>
                </div>

                <div style="margin-bottom: 2rem;">
                    <h4>Customer Information</h4>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-top: 1rem;">
                        <div><strong>Name:</strong> ${order.customer_name || 'N/A'}</div>
                        <div><strong>Phone:</strong> ${order.customer_phone || 'N/A'}</div>
                        <div><strong>Email:</strong> ${order.customer_email || 'N/A'}</div>
                    </div>
                </div>

                <div style="margin-bottom: 2rem;">
                    <h4>Status & Payment</h4>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-top: 1rem;">
                        <div>
                            <strong>Status:</strong>
                            <select id="orderStatus" style="margin-left: 0.5rem; padding: 0.25rem;">
                                <option value="pending" ${order.status === 'pending' ? 'selected' : ''}>Pending</option>
                                <option value="confirmed" ${order.status === 'confirmed' ? 'selected' : ''}>Confirmed</option>
                                <option value="preparing" ${order.status === 'preparing' ? 'selected' : ''}>Preparing</option>
                                <option value="ready" ${order.status === 'ready' ? 'selected' : ''}>Ready</option>
                                <option value="delivered" ${order.status === 'delivered' ? 'selected' : ''}>Delivered</option>
                                <option value="cancelled" ${order.status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
                            </select>
                        </div>
                        <div>
                            <strong>Payment:</strong>
                            <select id="paymentStatus" style="margin-left: 0.5rem; padding: 0.25rem;">
                                <option value="pending" ${order.payment_status === 'pending' ? 'selected' : ''}>Pending</option>
                                <option value="paid" ${order.payment_status === 'paid' ? 'selected' : ''}>Paid</option>
                                <option value="failed" ${order.payment_status === 'failed' ? 'selected' : ''}>Failed</option>
                                <option value="refunded" ${order.payment_status === 'refunded' ? 'selected' : ''}>Refunded</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div style="margin-bottom: 2rem;">
                    <h4>Order Items</h4>
                    <div style="margin-top: 1rem;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="border-bottom: 1px solid #e5e7eb;">
                                    <th style="padding: 0.5rem; text-align: left;">Item</th>
                                    <th style="padding: 0.5rem; text-align: left;">Qty</th>
                                    <th style="padding: 0.5rem; text-align: left;">Price</th>
                                    <th style="padding: 0.5rem; text-align: left;">Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${order.items.map(item => `
                                    <tr style="border-bottom: 1px solid #f3f4f6;">
                                        <td style="padding: 0.5rem;">${item.item_name}</td>
                                        <td style="padding: 0.5rem;">${item.quantity}</td>
                                        <td style="padding: 0.5rem;">${Utils.formatPrice(item.unit_price)}</td>
                                        <td style="padding: 0.5rem;">${Utils.formatPrice(item.total_price)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                            <tfoot>
                                <tr style="border-top: 2px solid #e5e7eb;">
                                    <td colspan="3" style="padding: 0.5rem; text-align: right;"><strong>Total:</strong></td>
                                    <td style="padding: 0.5rem;"><strong>${Utils.formatPrice(order.total_amount)}</strong></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>

                ${order.notes ? `
                <div>
                    <h4>Notes</h4>
                    <p style="margin-top: 0.5rem; color: #6b7280;">${order.notes}</p>
                </div>
                ` : ''}
            `;

            document.getElementById('orderModal').classList.add('active');
        }

        function closeOrderModal() {
            document.getElementById('orderModal').classList.remove('active');
            currentOrder = null;
        }

        async function updateOrderStatus() {
            if (!currentOrder) return;

            const status = document.getElementById('orderStatus').value;
            const paymentStatus = document.getElementById('paymentStatus').value;

            try {
                const result = await APIService.updateOrderStatus(currentOrder.id, status, paymentStatus);
                
                if (result.success) {
                    Utils.showToast('Order updated successfully', 'success');
                    closeOrderModal();
                    await loadOrders();
                } else {
                    Utils.showToast(result.message, 'error');
                }
            } catch (error) {
                console.error('Failed to update order:', error);
                Utils.showToast('Failed to update order', 'error');
            }
        }

        async function quickUpdateStatus(orderId) {
            const order = orders.find(o => o.id === orderId);
            if (!order) return;

            const statusOptions = ['pending', 'confirmed', 'preparing', 'ready', 'delivered', 'cancelled'];
            const currentStatusIndex = statusOptions.indexOf(order.status);
            const nextStatus = statusOptions[(currentStatusIndex + 1) % statusOptions.length];

            try {
                const result = await APIService.updateOrderStatus(orderId, nextStatus);
                
                if (result.success) {
                    Utils.showToast(`Order status updated to ${nextStatus}`, 'success');
                    await loadOrders();
                } else {
                    Utils.showToast(result.message, 'error');
                }
            } catch (error) {
                console.error('Failed to update order status:', error);
                Utils.showToast('Failed to update order status', 'error');
            }
        }

        function debounceSearch() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                filterAndDisplayOrders();
            }, 300);
        }

        async function refreshOrders() {
            await loadOrders();
            Utils.showToast('Orders refreshed', 'success');
        }

        function exportOrders() {
            Utils.showToast('Export functionality coming soon', 'info');
        }

        function showError(message) {
            const container = document.getElementById('ordersContainer');
            container.innerHTML = `<p style="text-align: center; color: #ef4444;">${message}</p>`;
        }

        async function logout() {
            try {
                await APIService.logout();
                Utils.showToast('Logged out successfully', 'success');
                setTimeout(() => {
                    window.location.href = '../login.html';
                }, 1000);
            } catch (error) {
                console.error('Logout failed:', error);
                Utils.showToast('Logout failed', 'error');
            }
        }
    </script>
</body>
</html>